Follow the rules in rules.md when making any changes. Update all relevant documentation (BLUEPRINT.md, FEATURES.md, ISSUES.md) as required by the rules. Maintain changelog entries in BLUEPRINT.md for every change.

Goal

On initial page load, the DayTimeline should:

Select today (tenant timezone) in the scroller and

Open the Day scheduler for today below.
After that, users can horizontally scroll without opening days until they explicitly click a pill.
Today and Jump to date must center the pill and open that day. Horizontal scroll must be locked (no vertical drift).

Scope & files

/app/frontend/src/features/booking/CalendarPage.tsx

/app/frontend/src/features/booking/components/DayTimeline.tsx

/app/frontend/src/features/booking/components/DayPill.tsx

/app/frontend/src/features/booking/components/MiniMonthPopover.tsx

Timeline CSS/Tailwind styles

Required changes

Initial selection = today, open scheduler

Hydrate timezone: tz = tenantTimezone || 'Africa/Johannesburg'.

Parse ?date=YYYY-MM-DD. If present & valid → use it; else today.

On mount:

const initial = (urlDate ?? dayjs().tz(tz)).startOf('day');
setFocusedDate(initial);
setSelectedDate(initial);              // OPEN scheduler on first load
replaceUrlParam('date', initial.format('YYYY-MM-DD'));
await nextFrame();                     // ensure virtualizer measured
timelineRef.current?.centerOnDate(initial, { behavior: 'instant' });


Keep the split state model: scrolling only updates focusedDate. Only click/tap (and Today/Jump) updates selectedDate.

Click opens & recenters (no auto-open on scroll)

DayPill.onClick:

onClick={() => {
  setFocusedDate(date);
  setSelectedDate(date);
  replaceUrlParam('date', date.format('YYYY-MM-DD'));
  timelineRef.current?.centerOnDate(date, { behavior: 'smooth' });
}}


Remove/ensure no code path sets selectedDate from scroll events.

Today & Jump-to-date center and open

Today handler:

const today = dayjs().tz(tz).startOf('day');
setFocusedDate(today);
setSelectedDate(today);
replaceUrlParam('date', today.format('YYYY-MM-DD'));
await nextFrame();
timelineRef.current?.centerOnDate(today, { behavior: 'smooth' });


MiniMonthPopover onPick(date): identical flow.

Date/index mapping stability

Use fixed EPOCH at midnight in tenant TZ:

const EPOCH = dayjs.tz('2024-01-01', tz).startOf('day');
const dateFromIndex = (i:number) => EPOCH.add(i, 'day');
const indexFromDate = (d:Dayjs) => d.tz(tz).startOf('day').diff(EPOCH, 'day');


Always .tz(tz).startOf('day') before mapping.

Expose reliable centering API

DayTimeline (via forwardRef):

useImperativeHandle(ref, () => ({
  async centerOnDate(date: Dayjs, opts?: ScrollToOptions) {
    await Promise.resolve();          // settle layout
    virtualizer.measure();
    const idx = indexFromDate(date);
    const offset = virtualizer.getOffsetForIndex(idx);
    const target = offset - (container.clientWidth - itemWidth)/2;
    container.scrollTo({ left: Math.max(target, 0), behavior: opts?.behavior ?? 'smooth' });
  }
}));


Provide nextFrame = () => new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

Lock horizontal axis (no vertical drift)

Scroller container classes:

overflow-x-auto overflow-y-hidden
snap-x snap-mandatory
touch-pan-x overscroll-x-contain overscroll-y-none
whitespace-nowrap
h-[88px] flex items-stretch
[-webkit-overflow-scrolling:touch]


Pill wrapper:

inline-flex snap-center items-stretch h-full


Ensure parent row has fixed height and no vertical scroll.

Tests

Unit

indexFromDate/dateFromIndex round-trip across months & DST (tenant TZ).

URL hydration: valid ?date= opens that day; missing → opens today.

Integration

Initial load: pill for today is focused & selected, scroller centered, DayView shown.

Scroll: only focused changes; selected unchanged until click.

Click different day: selected updates, scroller recenters, DayView updates.

Today and Jump both center and open the correct day.

E2E (mobile)

Horizontal flick does not open days; only tap does.

No vertical movement of pills while scrolling.

Docs

BLUEPRINT.md Section 7: clarify initial open behavior (today), split focused/selected, Today/Jump recentering; add changelog.

FEATURES.md: mark “Continuous DayTimeline – initial‑open + centering behavior” as implemented/verified.

ISSUES.md: note any edge‑case findings (e.g., extreme timezones/DST transitions).

Acceptance criteria

On first load (or valid ?date=), the chosen day is selected, scroller centered, and scheduler open.

Scrolling never opens a day; clicking a pill does.

Today/Jump always center & open their target.

Pills cannot move vertically during horizontal scroll.